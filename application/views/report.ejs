<%- include('partials/_head'); %>
<%- include('partials/_header'); %>

<style>
  body {
    background-color: #000;
    color: #fff;
    font-family: 'Open Sans', sans-serif;
    padding: 2rem;
  }

  .report-wrapper {
    max-width: 960px;
    margin: 2rem auto;
    padding: 1rem;
    color: #fff;
  }

  .report-title {
    color: #e50914;
    font-size: 2rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .report-username {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 2rem;
  }

  .report-stats {
    display: flex;
    justify-content: center;
    gap: 4rem;
    margin: 1.5rem 0 2.5rem;
  }

  .stat-box {
    text-align: center;
  }

  .stat-label {
    color: #aaa;
    font-size: 0.9rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.2rem;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 0.25rem;
  }

  .cards-container {
    display: flex;
    gap: 2rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .highlight-card {
    background-color: #1B1C1C;
    border-radius: 12px;
    padding: 1.5rem;
    width: 300px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    color: #fff;
  }

  .highlight-card h3 {
    font-size: 1.2rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
  }

  .highlight-card h3 img {
    width: 32px;
    margin-right: 0.5rem;
  }

  .media-section {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .poster {
    width: 90px;
    height: 130px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .media-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  .media-details .title {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 0.4rem;
  }

  .media-details .info-line {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    margin-top: 0.3rem;
    color: #ccc;
  }

  .media-details .info-line img {
    width: 16px;
    margin-right: 0.4rem;
  }

  .detail-line {
    font-size: 0.75rem;
    color: #aaa;
    margin-bottom: 0.3rem;
  }

  .detail-line strong {
    color: #fff;
    font-weight: 600;
    margin-right: 0.3rem;
  }

  .chart-section {
    margin-top: 3rem;
    text-align: center;
  }

  .chart-section canvas {
    max-width: 900px;
    height: 320px !important;
    display: block;
    margin: 2rem auto;
  }

  .section-title {
    font-size: 1.6rem;
    color: #e50914;
    font-weight: bold;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  #genrePieChart {
    max-width: 320px;
    margin: 0 auto;
  }

  .chart-wrapper {
    width: 100%;
    max-width: 900px;
    margin: 2rem auto;
    position: relative;
    height: 320px;
  }

  .chart-wrapper canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

.binge-section {
  margin-top: 8rem; /* more space under the chart */
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}

.binge-title {
  font-size: 1.6rem;
  color: #fff;
  font-weight: bold;
  margin-bottom: 1.5rem;
  margin-left: 2rem; /* aligns with chart title (if wrapped in same container) */
}

.binge-list {
  display: flex;
  gap: 2rem;
  justify-content: center;
  flex-wrap: wrap;
}

.binge-item {
  background-color: #1b1b1b;
  border-radius: 12px;
  padding: 1.25rem;
  width: 220px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  text-align: left;
}

.binge-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  justify-content: center;
}

.binge-name {
  font-size: 1rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
  color: #fff;
}

.binge-detail {
  font-size: 0.85rem;
  color: #ccc;
  margin-bottom: 0.25rem;
}

.media-list-section {
  max-width: 1000px;
  margin: 5rem auto 0 auto;
  padding: 0 2rem;
}

.section-title {
  font-size: 1.6rem;
  color: #e50914;
  font-weight: bold;
  margin: 3rem auto; 
  margin-bottom: 1rem;
}

.watched-productions-section {
  margin-top: 6rem;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}

.watched-columns {
  display: flex;
  flex-wrap: wrap;
  gap: 4rem;
  justify-content: space-between;
}

.watched-column {
  flex: 1;
  min-width: 300px;
}

.watched-column h3 {
  font-size: 1.4rem;
  color: #fff;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.production-card {
  background-color: #1c1c1c;
  border-radius: 1rem;
  padding: 1rem 1.5rem;
  margin-bottom: 1rem;
  color: #e0e0e0;
}

.production-card h4 {
  font-size: 1.2rem;
  font-weight: 600;
  color: #e50914;
  margin-bottom: 0.5rem;
}

.production-card p {
  margin: 0.25rem 0;
}

.icon-inline {
  width: 1rem;
  height: 1rem;
  vertical-align: middle;
  margin-right: 0.3rem;
}

.watched-productions {
  max-width: 1000px;  /* Aligns with other sections */
  margin: 6rem auto;  /* Add vertical spacing */
  padding: 0 1rem;
}

.watched-columns {
  display: flex;
  justify-content: space-between;
  gap: 2rem;
  flex-wrap: wrap;
}

.watched-column {
  flex: 1;
  min-width: 300px;
}

.watched-column h3 {
  font-size: 1.4rem;
  color: #fff;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.watched-column h3 img {
  width: 1.3rem;
  height: 1.3rem;
  object-fit: contain;
  vertical-align: middle;
}

.watched-item {
  background-color: #1c1c1c;
  padding: 1rem 1.2rem;
  border-radius: 1rem;
  margin-bottom: 1.2rem;
}

.watched-item h4 {
  color: #e50914;
  margin: 0 0 0.3rem;
  font-size: 1.1rem;
}

.watched-item p {
  margin: 0.3rem 0;
  color: #ccc;
}

.watched-item .icon-text {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.watched-item .icon-text img {
  width: 1rem;
  height: 1rem;
}

</style>

<div class="report-wrapper">
  <h1 class="report-title">Netflix Wrapped Report</h1>
  <h2 class="report-username"><%= report.userName %></h2>

  <div class="report-stats">
    <div class="stat-box">
      <div class="stat-label">
        <img src="/assets/icons/clock.svg" width="18" /> Total Watch Time
      </div>
      <div class="stat-value"><%= Math.round(report.totalWatchTime).toLocaleString() %> min</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">
        <img src="/assets/icons/star.svg" width="18" /> Average Rating
      </div>
      <div class="stat-value"><%= report.averageRating.toFixed(1) %></div>
    </div>
  </div>

  <div class="cards-container">
    <!-- Best Movie Watched -->
    <div class="highlight-card">
      <h3><img src="/assets/icons/movie.svg" alt="Movie" /> Best Movie Watched</h3>
      <div class="media-section">
        <img class="poster" src="https://image.tmdb.org/t/p/original<%= report.bestMovie.imageUrl.replace('http://localhost:3000', '') %>" alt="Movie Poster" />
        <div class="media-details">
          <div class="title"><%= report.bestMovie.title %></div>
          <div class="info-line">
            <img src="/assets/icons/star.svg" alt="Rating" />
            <%= report.bestMovie.rating.toFixed(1) %>
          </div>
          <p class="detail-line">
            <strong>Genre:</strong> <%= report.bestMovie.genre.join(', ') %>
          </p>
        </div>
      </div>
    </div>

    <!-- Best TV Show Watched -->
    <div class="highlight-card">
      <h3><img src="/assets/icons/tv.svg" alt="TV" /> Best TV Show Watched</h3>
      <div class="media-section">
        <img class="poster" src="https://image.tmdb.org/t/p/original<%= report.bestTV.imageUrl.replace('http://localhost:3000', '') %>" alt="TV Poster" />

        <div class="media-details">
          <div class="title"><%= report.bestTV.title %></div>
          <div class="info-line">
            <img src="/assets/icons/star.svg" alt="Rating" />
            <%= report.bestTV.rating.toFixed(1) %>
          </div>
          <div class="info-line">
            <img src="/assets/icons/clock.svg" alt="Time" />
            <%= Math.round(report.bestTV.watchedTime) %> min
          </div>
          <p class="detail-line">
            <strong>Genre:</strong> <%= report.bestTV.genre.join(', ') %>
          </p>
          <p class="detail-line">
            <strong>Episodes:</strong> <%= report.bestTV.numberOfEpisodes %>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Genre Watch Time Pie Chart -->
<div class="chart-wrapper">
  <h3 class="section-title">Time Spent by Genre</h3>
  <canvas id="genrePieChart" width="320" height="320"></canvas>
</div>

<!-- Monthly Watch Time Chart -->
<div class="chart-wrapper">
  <h3 class="section-title">Monthly Watch Time Trend (in minutes)</h3>
  <canvas id="watchTimeChart" width="900" height="320" style="margin: 2rem auto; display: block;"></canvas>
</div>

<!-- Binge Sessions -->
<div class="binge-section">
  <h2 class="section-title">Top Binge Sessions</h2>
  <div class="binge-list">
    <% report.bingeSessions.forEach(session => { %>
      <div class="binge-item">
        <div class="binge-name"><%= session.production.title %></div>
        <div class="binge-detail"><strong>Genre:</strong> <%= session.production.genre[0] %></div>
        <div class="binge-detail"><strong>Date:</strong> <%= session.startTime.split(' ')[0] %></div>
        <div class="binge-detail"><strong>Watch Time:</strong> <%= session.totalWatchTime %> min</div>
        <div class="binge-detail"><strong>Episodes:</strong> <%= session.numberOfWatchedEpisodes %></div>
      </div>
    <% }) %>
  </div>
</div>

<div class="section-content">
  <section class="watched-productions">
    <h2 class="section-title">Watched Productions</h2>
    <div class="watched-columns">

      <!-- Movies Section -->
      <div class="watched-column">
        <h3><img src="assets/icons/movie.svg" alt="Movie Icon"> Movies</h3>
        <% report.watchedMovies.forEach(movie => { %>
          <div class="watched-item">
            <h4><%= movie.title %></h4>
            <p><strong>Genre:</strong> <%= movie.genre.join(', ') %></p>
            <p class="icon-text">
              <img src="assets/icons/star.svg" alt="Star"> <%= movie.rating.toFixed(1) %>
            </p>
            <p class="icon-text">
              <img src="assets/icons/clock.svg" alt="Clock"> <%= movie.watchedTime %> min
            </p>
          </div>
        <% }) %>
      </div>

      <!-- TV Series Section -->
      <div class="watched-column">
        <h3><img src="assets/icons/tv.svg" alt="TV Icon"> TV Series</h3>
        <% report.watchedTV.forEach(tv => { %>
          <div class="watched-item">
            <h4><%= tv.title %></h4>
            <p><strong>Genre:</strong> <%= tv.genre.join(', ') %></p>
            <p class="icon-text">
              <img src="assets/icons/star.svg" alt="Star"> <%= tv.rating.toFixed(1) %>
            </p>
            <p class="icon-text">
              <img src="assets/icons/clock.svg" alt="Clock"> <%= tv.watchedTime %> min
            </p>
          </div>
        <% }) %>
      </div>

    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const genreData = <%- JSON.stringify(report.genres) %>;
const genreCtx = document.getElementById('genrePieChart').getContext('2d');

new Chart(genreCtx, {
  type: 'pie',
  data: {
    labels: genreData.map(g => g.name),
    datasets: [{
      data: genreData.map(g => g.timeSpent),
      backgroundColor: [
        '#e50914',  // Netflix red
        '#4f4f4f',  // dark gray
        '#8e8e8e',  // medium gray
        '#aaaaaa',  // light gray
        '#333333',  // deep gray
        '#d81b60',  // rose
        '#1e88e5',  // blue
        '#43a047',  // green
        '#fdd835',  // yellow
        '#fb8c00',  // orange
        '#6a1b9a',  // purple
        '#00acc1'   // cyan
      ],
      borderColor: '#000',
      borderWidth: 2
    }]
  },
  options: {
    plugins: {
      legend: {
        position: 'right',
        align: 'center',
        labels: {
          color: '#fff',
          font: { size: 14 },
          boxWidth: 20,
          padding: 10
        }
      }
    }
  }
});
</script>

<script>
const chartData = <%- JSON.stringify(report.trends) %>;

// Convert month strings to readable labels like "Nov 2024"
const months = chartData.map(item => {
  const [year, month] = item.month.split('.');
  const date = new Date(`${year}-${month}-01`);
  return date.toLocaleString('default', { month: 'short', year: 'numeric' });
});

const times = chartData.map(item => item.timeSpent);

const watchCtx = document.getElementById('watchTimeChart').getContext('2d');

new Chart(watchCtx, {
  type: 'line',
  data: {
    labels: months,
    datasets: [{
      label: 'Time Spent (min)',
      data: times,
      fill: true,
      backgroundColor: 'rgba(229, 9, 20, 0.25)',
      borderColor: '#e50914',
      borderWidth: 2,
      tension: 0.4,
      pointBackgroundColor: '#e50914',
      pointRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false }
    },
    scales: {
      x: {
        ticks: { color: '#fff' },
        grid: { color: '#111' }
      },
      y: {
        beginAtZero: true,
        ticks: { color: '#fff' },
        grid: { color: '#111' }
      }
    }
  }
});

</script>

<%- include('partials/_footer'); %>
